#!/usr/bin/env ruby

RC_PATH = "#{ENV['HOME']}/.posterousrc"

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')

%w{postly irb}.each { |f| require f }

rc  = File.open(RC_PATH,File::RDWR|File::APPEND|File::CREAT)
yml = YAML.load_file(rc)

if yml.is_a?(Hash)
  cfg = yml
else
  cfg = {}
  puts "Email Address:"
  cfg['username'] = gets.chomp
  puts "Password:"
  cfg['password'] = gets.chomp
  puts "Api Token:"
  cfg['api_token'] = gets.chomp
  rc.puts cfg.to_yaml
end

rc.close

Postly.config = cfg

include Postly

IRB.setup(nil)
irb = IRB::Irb.new

IRB.conf[:MAIN_CONTEXT] = irb.context

irb.context.evaluate("require 'irb/completion'", 0)

trap("SIGINT") do
  irb.signal_handle
end

catch(:IRB_EXIT) do
  irb.eval_input
end
